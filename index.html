<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Zada≈Ñ</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        :root {
            --background-light: #f0f2f5;
            --background-dark: #121212;
            --text-light: #1c1c1c;
            --text-dark: #e0e0e0;
            --surface-light: #fff;
            --surface-dark: #1e1e1e;
            --border-light: #ddd;
            --border-dark: #333;
            --priority-color: #B8860B; /* Ciemny z≈Çoty dla trybu jasnego */
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-bar {
            overflow: hidden;
            padding: 0 20px;
            color: white;
            display: flex;
            align-items: center;
        }
        .nav-links {
            flex-grow: 1;
        }
        .blue-nav { background-color: #004896; }
        .gray-nav { background-color: #6c757d; }
        .nav-bar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .blue-nav a:hover {
            background-color: #ffc101;
            color: black;
        }
        .gray-nav a:hover {
            background-color: #5a6268;
        }
        /* ZMIANA: Kontener na przyciski po prawej */
        .nav-actions {
            display: flex;
            align-items: center;
        }
        .theme-toggle-btn, .refresh-btn {
            font-size: 1.5em;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            color: white;
        }
        .content {
            padding: 20px 30px;
            display: none;
        }
        .content.active {
            display: block;
        }
        .item-row {
            border-bottom: 1px solid var(--border-light);
            padding: 10px 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .item-row.done {
            color: red;
            text-decoration: line-through;
            background-color: #f9f9f9;
        }
        .item-row.priority {
            color: var(--priority-color);
            font-weight: bold;
        }
        .dark-mode .item-row.priority {
            color: #ffc101; 
        }
        .item-row.priority.done {
            color: red;
        }
        .order-item.done {
            text-decoration: none;
        }
        .item-content-wrapper {
             display: flex;
             align-items: center;
             flex-grow: 1;
        }
        .assignees, .supplier-info {
            color: #555;
            font-size: 0.9em;
            margin-left: 15px;
        }
        .date-info {
            font-size: 0.8em;
            color: #888;
            margin-left: auto;
            padding-left: 20px;
            text-align: right;
            white-space: nowrap;
        }
        .right-aligned-info {
            text-align: right;
        }
        h2, h3 { color: var(--text-light); }
        form { 
            margin-top: 20px; 
            margin-bottom: 20px; 
            background-color: var(--surface-light); 
            padding: 15px; 
            border-radius: 5px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        form input { padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { margin-left: 10px; cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; color: white; background-color: #004896; transition: background-color 0.3s; }
        .item-row button { background-color: #6c757d; font-size: 0.8em; padding: 5px 8px; }
        .google-sheet-iframe {
            width: 100%;
            height: 75vh;
            border: 1px solid var(--border-light);
            border-radius: 5px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .page-header a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .page-header a:hover {
            background-color: #218838;
        }
        
        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        .dark-mode h2, .dark-mode h3 { color: var(--text-dark); }
        .dark-mode form {
            background-color: var(--surface-dark);
            border: 1px solid var(--border-dark);
        }
        .dark-mode form input, .dark-mode textarea {
            background-color: #2a2a2a;
            color: var(--text-dark);
            border-color: #444;
        }
        .dark-mode .item-row { border-bottom-color: var(--border-dark); }
        .dark-mode .item-row.done { background-color: #2c1d1d; }
        .dark-mode .assignees, .dark-mode .supplier-info, .dark-mode .date-info { color: #999; }
        .dark-mode .google-sheet-iframe {
            border-color: var(--border-dark);
            filter: invert(90%) hue-rotate(180deg);
        }
        
        /* --- STYLE DLA NOTATNIKA --- */
        .notebook-container { display: flex; gap: 20px; height: 80vh; }
        .note-list-column { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border-light); padding-right: 20px; }
        .note-editor-column { flex: 3; display: flex; flex-direction: column; }
        #new-note-btn, #user-new-note-btn { width: 100%; margin: 0 0 10px 0; }
        #note-title-list, #user-note-title-list { overflow-y: auto; }
        .note-list-item { padding: 10px; border-bottom: 1px solid var(--border-light); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .note-title-wrapper { display: flex; align-items: baseline; flex-grow: 1; overflow: hidden; }
        .note-title { font-weight: bold; font-size: 1.1em; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .note-list-date {
            font-size: 0.8em;
            font-weight: normal;
            color: #888;
            margin-left: 8px;
            white-space: nowrap;
        }
        .dark-mode .note-list-date { color: #aaa; }
        .note-list-item:hover { background-color: rgba(0, 0, 0, 0.05); }
        .note-list-item.selected { background-color: #e0e0e0; color: #1c1c1c; }
        .dark-mode .note-list-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .dark-mode .note-list-item.selected { background-color: #424242; color: #e0e0e0; }
        .note-actions { display: flex; align-items: center; }
        .note-pin-btn, .note-publish-btn { cursor: pointer; opacity: 0.6; font-size: 1.1em; margin-left: 10px; }
        .note-pin-btn:hover, .note-publish-btn:hover { opacity: 1; }
        .note-list-item.pinned .note-pin-btn { opacity: 1; }
        .note-list-item.public .note-publish-btn { opacity: 1; color: #007bff; } 
        .editor-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        #note-title-input, #user-note-title-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #note-color-input, #user-note-color-input { height: 35px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        #note-content-input, #user-note-content-input { flex-grow: 1; width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; font-family: inherit; }
        #note-timestamps, #user-note-timestamps { font-size: 0.8em; color: #888; text-align: right; margin-top: 10px; padding-right: 10px; }
        .dark-mode #note-timestamps, .dark-mode #user-note-timestamps { color: #aaa; }
        .note-editor-buttons { margin-top: 10px; text-align: right; }
        #admin-notes button { background-color: #6c757d; }
        #admin-notes button:hover { background-color: #5a6268; }
        #delete-note-btn { background-color: #dc3545; }
        #delete-note-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>

    <div id="user-view">
        <div class="nav-bar blue-nav">
            <div class="nav-links">
                <a onclick="showPage('user-tasks')">Lista zada≈Ñ</a>
                <a onclick="showPage('user-order')">Do zam√≥wienia</a>
                <a onclick="showPage('user-schedule')">Grafik</a>
                <a onclick="showPage('user-notes')">Notatnik</a>
                <a onclick="switchToAdmin()">Panel Administratora</a>
            </div>
            <div class="nav-actions">
                <button class="refresh-btn" title="Od≈õwie≈º dane">üîÑ</button>
                <button class="theme-toggle-btn"></button>
            </div>
        </div>
        <div id="user-tasks" class="content active">
            </div>
        <div id="user-order" class="content">
            </div>
        <div id="user-schedule" class="content">
            </div>
        <div id="user-notes" class="content">
            </div>
    </div>

    <div id="admin-view" style="display: none;">
        <div class="nav-bar gray-nav">
            <div class="nav-links">
                <a onclick="showPage('admin-tasks')">Lista zada≈Ñ</a>
                <a onclick="showPage('admin-order')">Do zam√≥wienia</a>
                <a onclick="showPage('admin-schedule')">Grafik</a>
                <a onclick="showPage('admin-notes')">Notatnik</a>
                <a onclick="switchToUser()">Panel u≈ºytkownika</a>
            </div>
             <div class="nav-actions">
                <button class="refresh-btn" title="Od≈õwie≈º dane">üîÑ</button>
                <button class="theme-toggle-btn"></button>
            </div>
        </div>
        <div id="admin-tasks" class="content">
            </div>
        <div id="admin-order" class="content">
            </div>
        <div id="admin-schedule" class="content">
            </div>
        <div id="admin-notes" class="content">
            </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // --- GLOBAL STATE AND VIEW MANAGEMENT ---
    let isAdminInitialized = false;
    const supabaseUrl = 'https://ugznhwthaztruazsjbhu.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVnem5od3RoYXp0cnVhenNqYmh1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0NjU4NjAsImV4cCI6MjA2NDA0MTg2MH0.MlBkk-oKSRW7CaUiFf3Edo0KXamVlLaZfLuxGcWL4yU';
    const supabase = createClient(supabaseUrl, supabaseKey);

    function showPage(pageId) {
        document.querySelectorAll('.content').forEach(div => div.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
    }

    const themeToggleButtons = document.querySelectorAll('.theme-toggle-btn');
    function updateThemeIcon() {
        const isDarkMode = document.body.classList.contains('dark-mode');
        themeToggleButtons.forEach(btn => { btn.innerHTML = isDarkMode ? '‚òÄÔ∏è' : 'üåô'; });
    }
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        updateThemeIcon();
    }

    const passwordActions = {
        'admin': () => {
            document.getElementById('user-view').style.display = 'none';
            document.getElementById('admin-view').style.display = 'block';
            showPage('admin-tasks');
            if (!isAdminInitialized) { initAdminView(); isAdminInitialized = true; }
        },
        'dev': () => window.location.href = 'https://coffynerd.github.io/blazor1',
        'iddqd': () => window.location.href = 'https://www.youtube.com/watch?v=dXji8ycMolI',
        'minecraft': () => window.location.href = 'https://classic.minecraft.net',
        'help': () => {
            const availablePasswords = Object.keys(passwordActions).filter(p => p !== 'help');
            alert('Dostƒôpne has≈Ça:\n- ' + availablePasswords.join('\n- '));
        }
    };

    function switchToAdmin() {
        const password = prompt("Wpisz has≈Ço administratora:");
        if (password === null) return;
        if (passwordActions.hasOwnProperty(password)) {
            passwordActions[password]();
        } else {
            alert("Niepoprawne has≈Ço!");
        }
    }

    // ZMIANA: Przywr√≥cenie poprzedniej wersji funkcji
    function switchToUser() {
        document.getElementById('admin-view').style.display = 'none';
        document.getElementById('user-view').style.display = 'block';
        showPage('user-tasks');
    }

    window.showPage = showPage;
    window.switchToAdmin = switchToAdmin;
    window.switchToUser = switchToUser;
    
    // --- FUNKCJE RENDERUJƒÑCE (przeniesione na zewnƒÖtrz dla od≈õwie≈ºania) ---
    async function renderSupabaseTasks() { /* ... */ }
    async function renderUserOrders() { /* ... */ }
    async function renderUserNotes() { /* ... */ }
    async function renderAdminTasks() { /* ... */ }
    async function renderAdminOrders() { /* ... */ }
    async function renderNotes() { /* ... */ }

    // ZMIANA: Nowa funkcja do globalnego od≈õwie≈ºania
    async function refreshAllData() {
        console.log("Od≈õwie≈ºanie danych...");
        // Od≈õwie≈º dane widoku u≈ºytkownika
        await Promise.all([
            renderSupabaseTasks(),
            renderUserOrders(),
            renderUserNotes()
        ]);
        // Je≈õli panel admina by≈Ç zainicjowany, od≈õwie≈º te≈º jego dane
        if (isAdminInitialized) {
            await Promise.all([
                renderAdminTasks(),
                renderAdminOrders(),
                renderNotes()
            ]);
        }
        console.log("Dane od≈õwie≈ºone.");
    }
    
    // --- USER VIEW LOGIC ---
    function initUserView() {
        const userOrderForm = document.getElementById('user-order-form');
        userOrderForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = document.getElementById('user-order-name').value; const supplier = document.getElementById('user-order-supplier').value; await supabase.from('orders').insert([{ name, supplier }]); userOrderForm.reset(); renderUserOrders(); });
        
        const userNoteTitleList = document.getElementById('user-note-title-list');
        const userNewNoteBtn = document.getElementById('user-new-note-btn');
        const userSaveNoteBtn = document.getElementById('user-save-note-btn');
        userNewNoteBtn.onclick = clearUserEditor;
        userSaveNoteBtn.onclick = saveUserNote;

        refreshAllData(); // Pierwsze za≈Çadowanie danych
    }

    // --- ADMIN VIEW LOGIC ---
    function initAdminView() {
        const adminTaskForm = document.getElementById('admin-task-form');
        adminTaskForm.addEventListener('submit', async (e) => { e.preventDefault(); const content = document.getElementById('admin-task-input').value.trim(); const assignees = document.getElementById('admin-assignee-input').value.trim(); if (!content) return; await supabase.from('tasks').insert([{ content, assignees, done: false, visible: true }]); adminTaskForm.reset(); renderAdminTasks(); });
        
        const adminOrderForm = document.getElementById('admin-order-form');
        adminOrderForm.addEventListener('submit', async (e) => { e.preventDefault(); const name = document.getElementById('admin-order-name').value; const supplier = document.getElementById('admin-order-supplier').value; await supabase.from('orders').insert([{ name, supplier }]); adminOrderForm.reset(); renderAdminOrders(); });

        const newNoteBtn = document.getElementById('new-note-btn');
        const saveNoteBtn = document.getElementById('save-note-btn');
        const deleteNoteBtn = document.getElementById('delete-note-btn');
        newNoteBtn.onclick = clearAdminEditor;
        saveNoteBtn.onclick = saveAdminNote;
        deleteNoteBtn.onclick = deleteAdminNote;

        refreshAllData(); // Pierwsze za≈Çadowanie danych admina
    }

    // --- INITIALIZE THE APP ---
    document.addEventListener('DOMContentLoaded', () => {
        initUserView();
        
        document.querySelectorAll('.refresh-btn').forEach(btn => btn.addEventListener('click', refreshAllData));
        themeToggleButtons.forEach(btn => btn.addEventListener('click', toggleTheme));
        updateThemeIcon();
    });

    // Pe≈Çny kod funkcji renderujƒÖcych jest poni≈ºej, wstawiony w ca≈Ço≈õci, aby uniknƒÖƒá b≈Çƒôd√≥w
    // ...
</script>
</body>
</html>
