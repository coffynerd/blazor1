<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista Zadań</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <style>
        :root {
            --background-light: #f0f2f5;
            --background-dark: #121212;
            --text-light: #1c1c1c;
            --text-dark: #e0e0e0;
            --surface-light: #fff;
            --surface-dark: #1e1e1e;
            --border-light: #ddd;
            --border-dark: #333;
            --priority-color: #B8860B; /* Ciemny złoty dla trybu jasnego */
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background-color: var(--background-light);
            color: var(--text-light);
            transition: background-color 0.3s, color 0.3s;
        }
        .nav-bar {
            overflow: hidden;
            padding: 0 20px;
            color: white;
            display: flex;
            align-items: center;
        }
        .nav-links {
            flex-grow: 1;
        }
        .blue-nav { background-color: #004896; }
        .gray-nav { background-color: #6c757d; }
        .nav-bar a {
            float: left;
            display: block;
            color: white;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .blue-nav a:hover {
            background-color: #ffc101;
            color: black;
        }
        .gray-nav a:hover {
            background-color: #5a6268;
        }
        .theme-toggle-btn {
            font-size: 1.5em;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 10px;
            margin-left: auto;
        }
        .content {
            padding: 20px 30px;
            display: none;
        }
        .content.active {
            display: block;
        }
        .item-row {
            border-bottom: 1px solid var(--border-light);
            padding: 10px 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .item-row.done {
            color: red;
            text-decoration: line-through;
            background-color: #f9f9f9;
        }
        .item-row.priority {
            color: var(--priority-color);
            font-weight: bold;
        }
        .dark-mode .item-row.priority {
            color: #ffc101; 
        }
        .item-row.priority.done {
            color: red;
        }
        .order-item.done {
            text-decoration: none;
        }
        .item-content-wrapper {
             display: flex;
             align-items: center;
             flex-grow: 1;
        }
        .assignees, .supplier-info {
            color: #555;
            font-size: 0.9em;
            margin-left: 15px;
        }
        .date-info {
            font-size: 0.8em;
            color: #888;
            margin-left: auto;
            padding-left: 20px;
            text-align: right;
            white-space: nowrap;
        }
        .right-aligned-info {
            text-align: right;
        }
        h2, h3 { color: var(--text-light); }
        form { 
            margin-top: 20px; 
            margin-bottom: 20px; 
            background-color: var(--surface-light); 
            padding: 15px; 
            border-radius: 5px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        form input { padding: 8px; margin-right: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { margin-left: 10px; cursor: pointer; padding: 8px 12px; border: none; border-radius: 4px; color: white; background-color: #004896; transition: background-color 0.3s; }
        .item-row button { background-color: #6c757d; font-size: 0.8em; padding: 5px 8px; }
        .google-sheet-iframe {
            width: 100%;
            height: 75vh;
            border: 1px solid var(--border-light);
            border-radius: 5px;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .page-header a {
            display: inline-block;
            padding: 8px 16px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        .page-header a:hover {
            background-color: #218838;
        }
        
        /* --- DARK MODE STYLES --- */
        body.dark-mode {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }
        .dark-mode h2, .dark-mode h3 { color: var(--text-dark); }
        .dark-mode form {
            background-color: var(--surface-dark);
            border: 1px solid var(--border-dark);
        }
        .dark-mode form input, .dark-mode textarea {
            background-color: #2a2a2a;
            color: var(--text-dark);
            border-color: #444;
        }
        .dark-mode .item-row { border-bottom-color: var(--border-dark); }
        .dark-mode .item-row.done { background-color: #2c1d1d; }
        .dark-mode .assignees, .dark-mode .supplier-info, .dark-mode .date-info { color: #999; }
        .dark-mode .google-sheet-iframe {
            border-color: var(--border-dark);
            filter: invert(90%) hue-rotate(180deg);
        }
        
        /* --- STYLE DLA NOTATNIKA --- */
        .notebook-container { display: flex; gap: 20px; height: 80vh; }
        .note-list-column { flex: 1; display: flex; flex-direction: column; border-right: 1px solid var(--border-light); padding-right: 20px; }
        .note-editor-column { flex: 3; display: flex; flex-direction: column; }
        #new-note-btn, #user-new-note-btn { width: 100%; margin: 0 0 10px 0; }
        #note-title-list, #user-note-title-list { overflow-y: auto; }
        .note-list-item { padding: 10px; border-bottom: 1px solid var(--border-light); cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .note-title-wrapper { display: flex; align-items: baseline; flex-grow: 1; overflow: hidden; }
        .note-title { font-weight: bold; font-size: 1.1em; white-space: nowrap; text-overflow: ellipsis; overflow: hidden; }
        .note-list-date {
            font-size: 0.8em;
            font-weight: normal;
            color: #888;
            margin-left: 8px;
            white-space: nowrap;
        }
        .dark-mode .note-list-date { color: #aaa; }
        .note-list-item:hover { background-color: rgba(0, 0, 0, 0.05); }
        .note-list-item.selected { background-color: #e0e0e0; color: #1c1c1c; }
        .dark-mode .note-list-item:hover { background-color: rgba(255, 255, 255, 0.05); }
        .dark-mode .note-list-item.selected { background-color: #424242; color: #e0e0e0; }
        .note-actions { display: flex; align-items: center; }
        .note-pin-btn, .note-publish-btn { cursor: pointer; opacity: 0.6; font-size: 1.1em; margin-left: 10px; }
        .note-pin-btn:hover, .note-publish-btn:hover { opacity: 1; }
        .note-list-item.pinned .note-pin-btn { opacity: 1; }
        .note-list-item.public .note-publish-btn { opacity: 1; color: #007bff; } 
        .editor-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        #note-title-input, #user-note-title-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        #note-color-input, #user-note-color-input { height: 35px; padding: 2px; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        #note-content-input, #user-note-content-input { flex-grow: 1; width: 100%; box-sizing: border-box; padding: 10px; border: 1px solid #ccc; border-radius: 4px; resize: vertical; font-family: inherit; }
        #note-timestamps, #user-note-timestamps { font-size: 0.8em; color: #888; text-align: right; margin-top: 10px; padding-right: 10px; }
        .dark-mode #note-timestamps, .dark-mode #user-note-timestamps { color: #aaa; }
        .note-editor-buttons { margin-top: 10px; text-align: right; }
        #admin-notes button { background-color: #6c757d; }
        #admin-notes button:hover { background-color: #5a6268; }
        #delete-note-btn { background-color: #dc3545; }
        #delete-note-btn:hover { background-color: #c82333; }
    </style>
</head>
<body>

    <div id="user-view">
        <div class="nav-bar blue-nav">
            <div class="nav-links">
                <a onclick="showPage('user-tasks')">Lista zadań</a>
                <a onclick="showPage('user-order')">Do zamówienia</a>
                <a onclick="showPage('user-schedule')">Grafik</a>
                <a onclick="showPage('user-notes')">Notatnik</a>
            </div>
            <button class="theme-toggle-btn"></button>
            <a onclick="switchToAdmin()">Panel Administratora</a>
        </div>
        <div id="user-tasks" class="content active">
            <h2>Lista Zadań</h2>
            <div id="supabase-task-list">Ładowanie...</div>
        </div>
        <div id="user-order" class="content">
            <h2>Do zamówienia</h2>
            <form id="user-order-form">
                <input type="text" id="user-order-name" placeholder="Nazwa produktu" required>
                <input type="text" id="user-order-supplier" placeholder="Dostawca">
                <button type="submit">Dodaj do listy</button>
            </form>
            <div id="user-order-list"></div>
        </div>
        <div id="user-schedule" class="content">
            <h2>Grafik</h2>
            <iframe class="google-sheet-iframe" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vTDEEc4cmeNHgLhQwp6zAXiUwhzwJSw0DYH-MV0XLEQBs9-2LvsklLOeSHbat4DZexTXeSad5MqzY_e/pubhtml?gid=0&single=true&widget=true&headers=false"></iframe>
        </div>
        <div id="user-notes" class="content">
            <h2>Notatnik</h2>
            <div class="notebook-container">
                <div class="note-list-column">
                    <button id="user-new-note-btn">+ Nowa notatka</button>
                    <div id="user-note-title-list">Brak notatek</div>
                </div>
                <div class="note-editor-column">
                    <div class="editor-header">
                        <input type="text" id="user-note-title-input" placeholder="Tytuł notatki...">
                        <input type="color" id="user-note-color-input" title="Wybierz kolor tytułu">
                    </div>
                    <textarea id="user-note-content-input" placeholder="Treść notatki..."></textarea>
                    <div id="user-note-timestamps"></div>
                    <div class="note-editor-buttons">
                        <button id="user-save-note-btn">Zapisz</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-view" style="display: none;">
        <div class="nav-bar gray-nav">
            <div class="nav-links">
                <a onclick="showPage('admin-tasks')">Lista zadań</a>
                <a onclick="showPage('admin-order')">Do zamówienia</a>
                <a onclick="showPage('admin-schedule')">Grafik</a>
                <a onclick="showPage('admin-notes')">Notatnik</a>
                <a onclick="switchToUser()">Panel użytkownika</a>
            </div>
            <button class="theme-toggle-btn"></button>
        </div>
        <div id="admin-tasks" class="content active">
            </div>
        <div id="admin-order" class="content">
            </div>
        <div id="admin-schedule" class="content">
            </div>
        <div id="admin-notes" class="content">
            <h2>Notatnik</h2>
            <div class="notebook-container">
                <div class="note-list-column">
                    <button id="new-note-btn">+ Nowa notatka</button>
                    <div id="note-title-list">Ładowanie...</div>
                </div>
                <div class="note-editor-column">
                    <div class="editor-header">
                        <input type="text" id="note-title-input" placeholder="Tytuł notatki...">
                        <input type="color" id="note-color-input" title="Wybierz kolor tytułu">
                    </div>
                    <textarea id="note-content-input" placeholder="Treść notatki..."></textarea>
                    <div id="note-timestamps"></div>
                    <div class="note-editor-buttons">
                        <button id="delete-note-btn">Usuń</button>
                        <button id="save-note-btn">Zapisz</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    // ... (kod do `switchToUser` bez zmian)

    // --- USER VIEW LOGIC ---
    function initUserView() {
        // ... (reszta kodu bez zmian)

        // --- Nowa logika dla notatnika użytkownika ---
        const userNoteTitleList = document.getElementById('user-note-title-list');
        const userNoteTitleInput = document.getElementById('user-note-title-input');
        const userNoteColorInput = document.getElementById('user-note-color-input');
        const userNoteContentInput = document.getElementById('user-note-content-input');
        const userNewNoteBtn = document.getElementById('user-new-note-btn');
        const userSaveNoteBtn = document.getElementById('user-save-note-btn');
        const userNoteTimestamps = document.getElementById('user-note-timestamps');
        let currentUserNoteId = null;

        function clearUserEditor() {
            currentUserNoteId = null;
            userNoteTitleInput.value = '';
            userNoteContentInput.value = '';
            userNoteColorInput.value = '#000000';
            userNoteTimestamps.innerHTML = '';
            const selected = userNoteTitleList.querySelector('.selected');
            if(selected) selected.classList.remove('selected');
        }

        function loadUserNoteIntoEditor(note) {
            currentUserNoteId = note.id;
            userNoteTitleInput.value = note.title;
            userNoteContentInput.value = note.content;
            userNoteColorInput.value = note.title_color || '#000000';
            const created = new Date(note.created_at).toLocaleString('pl-PL');
            const updated = note.updated_at ? new Date(note.updated_at).toLocaleString('pl-PL') : '---';
            userNoteTimestamps.innerHTML = `Utworzono: ${created} | Ost. edycja: ${updated}`;
            userNoteTitleList.querySelectorAll('.note-list-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.noteId == note.id);
            });
        }

        async function renderUserNotes() {
            const { data: notes, error } = await supabase.from('notes').select('*').eq('is_public', true).order('is_pinned', { ascending: false }).order('updated_at', { ascending: true });
            if (error) { userNoteTitleList.innerHTML = 'Błąd ładowania notatek.'; return; }
            if (notes.length === 0) { userNoteTitleList.innerHTML = 'Brak notatek.'; return; }
            userNoteTitleList.innerHTML = '';
            
            notes.forEach(note => {
                const item = document.createElement('div');
                item.classList.add('note-list-item');
                item.dataset.noteId = note.id;
                const titleSpan = document.createElement('span');
                titleSpan.classList.add('note-title');
                titleSpan.textContent = note.title || 'Nowa notatka';
                titleSpan.style.color = note.title_color || 'inherit';
                item.appendChild(titleSpan);
                item.onclick = () => loadUserNoteIntoEditor(note);
                userNoteTitleList.appendChild(item);
            });
             if(currentUserNoteId) { const selectedItem = userNoteTitleList.querySelector(`[data-note-id='${currentUserNoteId}']`); if(selectedItem) selectedItem.classList.add('selected'); }
        }

        userNewNoteBtn.onclick = clearUserEditor;
        userSaveNoteBtn.onclick = async () => {
            const title = userNoteTitleInput.value;
            const content = userNoteContentInput.value;
            const title_color = userNoteColorInput.value;
            if (!title) { alert('Tytuł notatki jest wymagany.'); return; }
            if (currentUserNoteId) {
                await supabase.from('notes').update({ title, content, title_color, updated_at: new Date() }).eq('id', currentUserNoteId);
            } else {
                const { data } = await supabase.from('notes').insert([{ title, content, title_color, is_public: true }]).select();
                if(data && data.length > 0) {
                    currentUserNoteId = data[0].id;
                }
            }
            renderUserNotes();
        };
        
        renderSupabaseTasks();
        renderUserOrders();
        renderUserNotes();
    }

    // --- ADMIN VIEW LOGIC ---
    function initAdminView() {
        // ... (reszta kodu bez zmian, w tym pełna funkcja `renderNotes` dla admina)
    }
    
    // --- SKRÓCONY KOD DLA CZYTELNOŚCI ---
    const fullInitAdminView = initAdminView;
    initAdminView = () => { /* Pełny kod z poprzedniej odpowiedzi */ };

    document.addEventListener('DOMContentLoaded', () => {
        initUserView();
        
        themeToggleButtons.forEach(btn => btn.addEventListener('click', toggleTheme));
        updateThemeIcon();
    });
</script>
</body>
</html>
